// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  emailVerified Boolean    @default(false)
  name          String
  image         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  lists              List[]
  contributions      Contribution[]
  accounts           Account[]
  sessions           Session[]
  createdEvents      Event[]            @relation("EventCreator")
  eventParticipants  EventParticipant[]
  debtsOwed          Debt[]             @relation("DebtsOwed")
  debtsReceived      Debt[]             @relation("DebtsReceived")
  bonusItemsAdded    Item[]             @relation("BonusItemsAdded")
}

model Event {
  id             String   @id @default(cuid())
  title          String
  description    String?
  creatorId      String
  invitationCode String   @unique @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  creator      User               @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  participants EventParticipant[]
  lists        List[]

  @@index([creatorId])
  @@index([invitationCode])
}

model EventParticipant {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  joinedAt  DateTime @default(now())

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model List {
  id          String   @id @default(cuid())
  userId      String
  eventId     String
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  items Item[]

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
}

model Item {
  id            String   @id @default(cuid())
  listId        String
  title         String
  description   String?
  amazonUrl     String?
  isBonus       Boolean  @default(false)
  addedByUserId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  list          List           @relation(fields: [listId], references: [id], onDelete: Cascade)
  contributions Contribution[]
  debts         Debt[]
  addedBy       User?          @relation("BonusItemsAdded", fields: [addedByUserId], references: [id], onDelete: SetNull)

  @@index([listId])
  @@index([addedByUserId])
  @@index([isBonus])
  @@index([createdAt])
  @@index([isBonus, createdAt])
}

model Contribution {
  id               String   @id @default(cuid())
  itemId           String
  userId           String
  amount           Float    @default(0)
  totalPrice       Float?
  contributionType String   @default("PARTIAL") // FULL, SHARED, PARTIAL
  note             String?
  hasAdvanced      Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([itemId, userId])
  @@index([itemId])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
}

model Account {
  id           String    @id @default(cuid())
  userId       String
  accountId    String
  providerId   String
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, accountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

model Debt {
  id         String    @id @default(cuid())
  itemId     String
  fromUserId String
  toUserId   String
  amount     Float
  isSettled  Boolean   @default(false)
  settledAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  item     Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  fromUser User @relation("DebtsOwed", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   User @relation("DebtsReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([itemId, fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([itemId])
  @@index([isSettled])
  @@index([fromUserId, isSettled])
  @@index([toUserId, isSettled])
}
