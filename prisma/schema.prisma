// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  emailVerified Boolean    @default(false)
  name          String
  image         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  lists              List[]
  contributions      Contribution[]
  accounts           Account[]
  sessions           Session[]
  createdEvents      Event[]            @relation("EventCreator")
  eventParticipants  EventParticipant[]
}

model Event {
  id             String   @id @default(cuid())
  title          String
  description    String?
  creatorId      String
  invitationCode String   @unique @default(cuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  creator      User               @relation("EventCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  participants EventParticipant[]
  lists        List[]

  @@index([creatorId])
  @@index([invitationCode])
}

model EventParticipant {
  id        String   @id @default(cuid())
  eventId   String
  userId    String
  joinedAt  DateTime @default(now())

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model List {
  id          String   @id @default(cuid())
  userId      String
  eventId     String
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  items Item[]

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
}

model Item {
  id          String   @id @default(cuid())
  listId      String
  title       String
  description String?
  amazonUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  list          List           @relation(fields: [listId], references: [id], onDelete: Cascade)
  contributions Contribution[]

  @@index([listId])
}

model Contribution {
  id               String   @id @default(cuid())
  itemId           String
  userId           String
  amount           Float    @default(0)
  totalPrice       Float?
  contributionType String   @default("PARTIAL") // FULL, SHARED, PARTIAL
  note             String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([itemId, userId])
  @@index([itemId])
  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String? @db.Text
  refreshToken      String? @db.Text
  idToken           String? @db.Text
  expiresAt         DateTime?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, accountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}
